version: '3'
services:
  kafka-connect:
    image: apache/kafka:3.5.1
    ports:
      - "8083:8083"
    volumes:
      - ./kafka-ssl:/opt/kafka/config/secrets
      - ./scripts:/scripts
    environment:
      CONNECT_BOOTSTRAP_SERVERS: your_remote_kafka_host:9092
      CONNECT_REST_ADVERTISED_HOST_NAME: kafka-connect
      CONNECT_REST_PORT: 8083
      CONNECT_GROUP_ID: connect-cluster
      CONNECT_CONFIG_STORAGE_TOPIC: connect-configs
      CONNECT_OFFSET_STORAGE_TOPIC: connect-offsets
      CONNECT_STATUS_STORAGE_TOPIC: connect-status
      CONNECT_CONFIG_STORAGE_REPLICATION_FACTOR: 1
      CONNECT_OFFSET_STORAGE_REPLICATION_FACTOR: 1
      CONNECT_STATUS_STORAGE_REPLICATION_FACTOR: 1
      CONNECT_KEY_CONVERTER: org.apache.kafka.connect.json.JsonConverter
      CONNECT_VALUE_CONVERTER: org.apache.kafka.connect.json.JsonConverter
      CONNECT_INTERNAL_KEY_CONVERTER: org.apache.kafka.connect.json.JsonConverter
      CONNECT_INTERNAL_VALUE_CONVERTER: org.apache.kafka.connect.json.JsonConverter
      CONNECT_PLUGIN_PATH: /opt/kafka/libs,/opt/kafka/plugins
      CONNECT_SECURITY_PROTOCOL: SSL
      CONNECT_SSL_TRUSTSTORE_LOCATION: /opt/kafka/config/secrets/kafka.client.truststore.jks
      CONNECT_SSL_TRUSTSTORE_PASSWORD: truststore_password
      CONNECT_SSL_KEYSTORE_LOCATION: /opt/kafka/config/secrets/kafka.client.keystore.jks
      CONNECT_SSL_KEYSTORE_PASSWORD: keystore_password
      CONNECT_SSL_KEY_PASSWORD: key_password
    command: 
      - bash
      - -c
      - |
        echo "Downloading Elasticsearch connector..."
        mkdir -p /opt/kafka/plugins/elasticsearch-connector
        curl -L https://d1i4a15mxbxib1.cloudfront.net/api/plugins/confluentinc/kafka-connect-elasticsearch/versions/14.0.6/confluentinc-kafka-connect-elasticsearch-14.0.6.zip -o /tmp/elasticsearch-connector.zip
        unzip /tmp/elasticsearch-connector.zip -d /opt/kafka/plugins/elasticsearch-connector
        rm /tmp/elasticsearch-connector.zip
        echo "Starting Kafka Connect..."
        /opt/kafka/bin/connect-distributed.sh /opt/kafka/config/connect-distributed.properties &
        /scripts/create-connector.sh

# Create a file named create-connector.sh in a 'scripts' directory with the following content:
#
# #!/bin/bash
#
# echo "Waiting for Kafka Connect to start listening on localhost:8083 ..."
#
# while [ $(curl -s -o /dev/null -w %{http_code} http://localhost:8083/connectors) -ne 200 ] ; do 
#     echo -e $(date) " Kafka Connect listener HTTP state: " $(curl -s -o /dev/null -w %{http_code} http://localhost:8083/connectors) " (waiting for 200)"
#     sleep 5 
# done
# 
# echo -e "\n--\n+> Creating Kafka Connect Elasticsearch sink"
#
# curl -X POST http://localhost:8083/connectors -H "Content-Type: application/json" -d '{
#     "name": "elasticsearch-sink",
#     "config": {
#         "connector.class": "io.confluent.connect.elasticsearch.ElasticsearchSinkConnector",
#         "tasks.max": "1",
#         "topics": "topic1,topic2,topic3",
#         "key.ignore": "true",
#         "connection.url": "http://your_elasticsearch_host:9200",
#         "type.name": "_doc",
#         "name": "elasticsearch-sink",
#         "key.converter": "org.apache.kafka.connect.storage.StringConverter",
#         "value.converter": "org.apache.kafka.connect.json.JsonConverter",
#         "value.converter.schemas.enable": "false"
#     }
# }'
#
# echo "Kafka Connect Elasticsearch sink created."
